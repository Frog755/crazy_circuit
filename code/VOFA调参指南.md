# VOFA+ 波形调参指南

## 一、VOFA使用步骤

### 1. 硬件连接
- 将TC264的调试串口（UART0，TX: P14_0, RX: P14_1）连接到电脑USB转串口
- 串口参数：115200, 8, N, 1

### 2. VOFA软件设置
1. 打开VOFA+软件
2. 选择**串口助手**模式
3. 选择正确的串口号
4. 波特率设置为 **115200**
5. **协议选择：JustFloat**
6. 点击"打开串口"

### 3. 代码启用
代码已经在`control()`函数中自动发送波形数据，无需额外配置。

---

## 二、输出的变量说明

### 控制链路变量（12个通道）

| 通道 | 变量名 | 说明 | 单位/范围 | 调参用途 |
|------|--------|------|-----------|----------|
| [0] | image_error | **图像误差** | 像素（-47 ~ +47） | **核心误差，观察路径偏差** |
| [1] | diff_angle | **角度环输出** | 角度值 | **观察角度控制响应** |
| [2] | speed_diff | **角速度环输出（差速）** | 速度差 | **观察差速控制效果** |
| [3] | current_base_speed | **基础速度** | 编码器脉冲数/周期 | 观察速度策略 |
| [4] | left_target_speed | **左目标速度** | 编码器脉冲数/周期 | **观察目标速度设定** |
| [5] | right_target_speed | **右目标速度** | 编码器脉冲数/周期 | **观察目标速度设定** |
| [6] | left_encoder | **左编码器反馈** | 编码器脉冲数/周期 | **观察实际速度反馈** |
| [7] | right_encoder | **右编码器反馈** | 编码器脉冲数/周期 | **观察实际速度反馈** |
| [8] | pid_L.Err | **左PID误差** | 速度误差 | **观察PID误差变化** |
| [9] | pid_R.Err | **右PID误差** | 速度误差 | **观察PID误差变化** |
| [10] | pwm_l | **左PWM输出** | PWM值（-6666 ~ +6666） | **观察最终控制输出** |
| [11] | pwm_r | **右PWM输出** | PWM值（-6666 ~ +6666） | **观察最终控制输出** |

### 关键关系链
```
图像误差 → 角度环PID → 角度输出 → 角速度环PID → 差速 → 
目标速度计算 → 速度环PID → PWM输出 → 电机 → 编码器反馈
```

---

## 三、如何通过波形调参

### 1. 速度环PID调参（最基础，最重要）

#### 观察通道组合：
- **通道4 & 6**：`left_target_speed` vs `left_encoder`
- **通道5 & 7**：`right_target_speed` vs `right_encoder`
- **通道8 & 10**：`pid_L.Err` vs `pwm_l`
- **通道9 & 11**：`pid_R.Err` vs `pwm_r`

#### 调参步骤：

**步骤1：观察速度跟随性能**
- 观察目标速度和编码器反馈的波形
- **理想状态**：编码器值应该紧紧跟随目标速度，误差小
- **如果编码器值滞后目标速度**：
  - 增大 Kp（响应更快）
  - 增大 Ki（消除稳态误差）
  
**步骤2：观察PID误差**
- 观察通道8和9（PID误差）
- **如果误差持续存在且不减小**：
  - 增大 Ki（增加积分项，消除稳态误差）
  
**步骤3：观察是否震荡**
- 观察编码器值和PWM输出的波形
- **如果出现震荡（波形上下波动）**：
  - 减小 Kp（降低响应速度）
  - 减小 Ki（降低积分项）
  - 增加 Kd（微分项抑制震荡）
  
**步骤4：观察超调**
- 观察速度变化时的响应
- **如果超调大（超过目标值很多）**：
  - 减小 Kp
  - 增加 Kd

#### 调参示例：
```c
// 当前参数（已优化）
pid_L.Kp = 5.0;   // 如果震荡，降低到 3.0-4.0
pid_L.Ki = 1.0;   // 如果有稳态误差，增加到 1.5-2.0
pid_L.Kd = 1.5;   // 如果震荡，增加到 2.0-2.5
```

---

### 2. 角度环PID调参

#### 观察通道组合：
- **通道0 & 1**：`image_error` vs `diff_angle`

#### 调参步骤：

**步骤1：观察角度响应**
- 当图像误差变化时，观察`diff_angle`的响应速度
- **如果响应太慢**：
  - 增大 `angle_pid.Kp`
  
**步骤2：观察是否震荡**
- 如果`diff_angle`震荡：
  - 减小 `angle_pid.Kp`
  - 增加 `angle_pid.Kd`

---

### 3. 角速度环PID调参

#### 观察通道组合：
- **通道1 & 2**：`diff_angle` vs `speed_diff`

#### 调参步骤：

**步骤1：观察差速响应**
- 观察从角度输出到差速输出的转换
- **如果差速变化太剧烈**：
  - 减小 `Angular_pid.Kp`
  
**步骤2：观察平滑性**
- 如果差速跳变太大：
  - 减小 `Angular_pid.Kp`
  - 增加 `Angular_pid.Kd`（抑制突变）

---

### 4. 整体系统调参流程

#### 第一阶段：速度环调试（最重要）
1. **先调速度环**，让电机能够稳定跟随目标速度
2. 设置一个固定的目标速度（如30），观察编码器是否能稳定跟随
3. 调整 `pid_L.Kp, pid_L.Ki, pid_L.Kd` 直到：
   - 编码器值稳定跟随目标速度
   - 无明显震荡
   - 无明显超调

#### 第二阶段：角度环调试
1. 速度环调好后，再调角度环
2. 观察图像误差变化时，角度输出的响应
3. 调整 `angle_pid.Kp, angle_pid.Kd`

#### 第三阶段：角速度环调试
1. 最后调角速度环，让差速变化更平滑
2. 调整 `Angular_pid.Kp, Angular_pid.Kd`

---

## 四、常见问题诊断

### 问题1：电机抖动/卡顿

**观察波形：**
- 查看通道10和11（PWM输出）是否在正负之间跳变
- 查看通道8和9（PID误差）是否异常大

**可能原因和解决方案：**
- **PID误差大且跳变**：降低Kp和Ki
- **PWM输出频繁变号**：增加输出死区（已实现，-50~+50）
- **编码器值跳变**：检查编码器硬件

### 问题2：速度跟不上目标速度

**观察波形：**
- 通道4与6的差值（目标速度 - 编码器值）
- 通道8（PID误差）是否持续为正或负

**解决方案：**
- 如果误差持续存在：增大Ki
- 如果响应慢：增大Kp

### 问题3：超调严重

**观察波形：**
- 编码器值是否超过目标速度很多

**解决方案：**
- 减小Kp
- 增加Kd

### 问题4：系统震荡

**观察波形：**
- 所有波形是否都在上下波动

**解决方案：**
- 降低所有PID的Kp值
- 降低Ki值
- 增加Kd值

---

## 五、推荐观察的波形组合

### 组合1：速度控制性能（最常用）
```
通道4: left_target_speed
通道6: left_encoder
通道5: right_target_speed  
通道7: right_encoder
```
**用途**：观察左右轮速度是否能稳定跟随目标速度

### 组合2：PID误差分析
```
通道8: pid_L.Err
通道9: pid_R.Err
通道10: pwm_l
通道11: pwm_r
```
**用途**：观察PID误差和输出，判断PID参数是否合适

### 组合3：控制链路分析
```
通道0: image_error
通道1: diff_angle
通道2: speed_diff
```
**用途**：观察从图像误差到差速的整个控制链路

### 组合4：目标速度vs实际速度
```
通道4: left_target_speed
通道6: left_encoder
```
**用途**：单独观察左轮的速度跟随性能

---

## 六、调参技巧

### 1. 从简单到复杂
- 先固定目标速度，调好速度环
- 再调角度环
- 最后调角速度环

### 2. 一次只调一个参数
- 每次只改变一个参数（Kp或Ki或Kd）
- 观察波形变化，判断效果

### 3. 参数调整幅度
- 第一次调整：±50%
- 第二次调整：±20%
- 精细调整：±10%

### 4. 观察时间
- 每次调整后，至少观察10-30秒的波形
- 看是否稳定，是否震荡

### 5. 记录参数
- 记录每次调整的参数和效果
- 找到最佳参数组合

---

## 七、理想波形特征

### 速度环理想波形：
- 编码器值紧紧跟随目标速度
- 误差（目标-实际）小且稳定
- 无明显震荡
- 无明显超调
- PWM输出平滑变化，不频繁跳变

### 角度环理想波形：
- 当图像误差变化时，角度输出快速响应
- 响应后快速稳定，不震荡

### 角速度环理想波形：
- 差速变化平滑，不突变
- 与角度输出匹配

---

## 八、调试示例场景

### 场景1：直线行驶调试
1. 让车在直线上行驶
2. 观察通道4和6，通道5和7
3. 如果左右速度不一致，调整速度环PID
4. 目标：左右编码器值应该接近，误差小

### 场景2：转弯调试
1. 让车通过弯道
2. 观察通道0（图像误差）和通道2（差速）
3. 观察差速是否合理响应图像误差
4. 调整角度环和角速度环参数

### 场景3：抖动问题调试
1. 观察通道10和11（PWM输出）
2. 如果PWM频繁变号，说明PID震荡
3. 降低Kp和Ki，增加Kd

---

## 九、代码使用说明

### 启用VOFA发送
代码已经在`control()`函数中自动发送，默认每次控制周期都发送（约200Hz）。

### 调整发送频率
在`motor.c`的`control()`函数中，修改：
```c
if(vofa_send_counter >= 1)  // 改为2或5可以降低发送频率
```

### 停止发送
可以注释掉`control()`函数中的vofa发送代码，或者在主循环中添加开关。

---

## 十、总结

### 调参优先级：
1. **速度环PID**（最重要，影响整体性能）
2. **角度环PID**（影响转向响应）
3. **角速度环PID**（影响差速平滑性）

### 关键观察指标：
1. 速度跟随误差（目标速度 - 编码器值）
2. PWM输出稳定性
3. 系统是否震荡
4. 响应速度是否合适

### 调参原则：
- 先保证稳定（不震荡）
- 再保证精度（误差小）
- 最后优化响应速度

祝调参顺利！🎯

